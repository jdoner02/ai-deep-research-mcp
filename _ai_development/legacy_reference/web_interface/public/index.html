<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Deep Research MCP - Interactive Research System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .research-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .progress-animation {
            animation: pulse 2s infinite;
        }
        .typing-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .source-card {
            transition: all 0.3s ease;
        }
        .source-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-brain text-blue-600"></i>
                AI Deep Research MCP
            </h1>
            <p class="text-gray-600 text-lg">
                Self-Hosted AI-Powered Deep Research System
            </p>
            <div class="mt-4 inline-flex items-center bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                <i class="fas fa-check-circle mr-2"></i>
                <span id="status">System Ready</span>
            </div>
        </div>

        <!-- Research Query Form -->
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-search text-blue-600"></i>
                    Research Query
                </h2>
                
                <form id="researchForm" class="space-y-4">
                    <div>
                        <label for="query" class="block text-sm font-medium text-gray-700 mb-2">
                            Research Question
                        </label>
                        <textarea 
                            id="query" 
                            name="query" 
                            rows="3" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Enter your research question (e.g., 'What are the latest developments in quantum computing and their implications for cryptography?')"
                            required
                        ></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="maxSources" class="block text-sm font-medium text-gray-700 mb-2">
                                Max Sources
                            </label>
                            <select id="maxSources" name="maxSources" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="3">3 Sources</option>
                                <option value="5" selected>5 Sources</option>
                                <option value="8">8 Sources</option>
                                <option value="10">10 Sources</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="maxDepth" class="block text-sm font-medium text-gray-700 mb-2">
                                Research Depth
                            </label>
                            <select id="maxDepth" name="maxDepth" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1">Surface (Depth 1)</option>
                                <option value="2" selected>Standard (Depth 2)</option>
                                <option value="3">Deep (Depth 3)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="citationStyle" class="block text-sm font-medium text-gray-700 mb-2">
                                Citation Style
                            </label>
                            <select id="citationStyle" name="citationStyle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="APA" selected>APA</option>
                                <option value="MLA">MLA</option>
                                <option value="Chicago">Chicago</option>
                                <option value="IEEE">IEEE</option>
                            </select>
                        </div>
                    </div>
                    
                    <button 
                        type="submit" 
                        id="submitBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                    >
                        <i class="fas fa-rocket mr-2"></i>
                        Start Deep Research
                    </button>
                </form>
            </div>

            <!-- Progress Section -->
            <div id="progressSection" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-cogs text-blue-600"></i>
                    Research Progress
                </h3>
                <div id="progressContainer" class="space-y-2">
                    <!-- Progress updates will appear here -->
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <!-- Research Answer -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-lightbulb text-yellow-500"></i>
                        Research Findings
                    </h3>
                    <div id="researchAnswer" class="prose max-w-none">
                        <!-- Answer will appear here -->
                    </div>
                    <div class="mt-4 text-sm text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        Execution time: <span id="executionTime">-</span>
                    </div>
                </div>

                <!-- Sources Used -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-link text-green-600"></i>
                        Sources Used
                    </h3>
                    <div id="sourcesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Sources will appear here -->
                    </div>
                </div>

                <!-- Bibliography -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-book text-purple-600"></i>
                        Bibliography
                    </h3>
                    <div id="bibliography" class="text-sm">
                        <!-- Bibliography will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // DOM elements
        const form = document.getElementById('researchForm');
        const submitBtn = document.getElementById('submitBtn');
        const status = document.getElementById('status');
        const progressSection = document.getElementById('progressSection');
        const progressContainer = document.getElementById('progressContainer');
        const resultsSection = document.getElementById('resultsSection');
        const researchAnswer = document.getElementById('researchAnswer');
        const executionTime = document.getElementById('executionTime');
        const sourcesContainer = document.getElementById('sourcesContainer');
        const bibliography = document.getElementById('bibliography');

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const query = formData.get('query');
            const maxSources = parseInt(formData.get('maxSources'));
            const maxDepth = parseInt(formData.get('maxDepth'));
            const citationStyle = formData.get('citationStyle');

            // Update UI
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="typing-indicator"></div> Researching...';
            status.textContent = 'Research in Progress';
            status.className = 'inline-flex items-center bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm';
            status.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Research in Progress';
            
            progressSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            progressContainer.innerHTML = '';

            try {
                const response = await fetch('/api/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query,
                        maxSources,
                        maxDepth,
                        citationStyle
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // The actual response will be handled via Socket.IO events
                
            } catch (error) {
                console.error('Error:', error);
                displayError(error.message);
            }
        });

        // Socket.IO event listeners
        socket.on('research-started', (data) => {
            addProgressUpdate(`🚀 Research started for: "${data.query}"`);
        });

        socket.on('research-progress', (data) => {
            addProgressUpdate(`📊 ${data.message}`);
        });

        socket.on('research-completed', (result) => {
            // Update UI
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i>Start Deep Research';
            status.textContent = 'Research Complete';
            status.className = 'inline-flex items-center bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm';
            status.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Research Complete';

            addProgressUpdate(`✅ Research completed successfully!`);
            
            // Display results
            displayResults(result);
        });

        socket.on('research-error', (data) => {
            displayError(data.error);
        });

        function addProgressUpdate(message) {
            const div = document.createElement('div');
            div.className = 'flex items-center text-sm text-gray-600 py-1';
            div.innerHTML = `
                <i class="fas fa-chevron-right text-blue-500 mr-2"></i>
                <span>${message}</span>
                <span class="text-xs text-gray-400 ml-auto">${new Date().toLocaleTimeString()}</span>
            `;
            progressContainer.appendChild(div);
            progressContainer.scrollTop = progressContainer.scrollHeight;
        }

        function displayResults(result) {
            // Display answer
            researchAnswer.innerHTML = `<p class="text-gray-800 leading-relaxed">${result.answer}</p>`;
            
            // Display execution time
            executionTime.textContent = `${result.execution_time.toFixed(2)} seconds`;
            
            // Display sources
            sourcesContainer.innerHTML = '';
            if (result.sources && result.sources.length > 0) {
                result.sources.forEach((source, index) => {
                    const sourceCard = document.createElement('div');
                    sourceCard.className = 'source-card bg-gray-50 p-4 rounded-lg border';
                    sourceCard.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-2">
                            <i class="fas fa-external-link-alt text-blue-500 mr-2"></i>
                            ${source.title || `Source ${index + 1}`}
                        </h4>
                        <p class="text-sm text-gray-600 mb-2">${source.author || 'Unknown Author'}</p>
                        <a href="${source.url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                            ${source.url}
                        </a>
                    `;
                    sourcesContainer.appendChild(sourceCard);
                });
            }
            
            // Display bibliography
            bibliography.innerHTML = `<pre class="whitespace-pre-wrap text-gray-700">${result.bibliography}</pre>`;
            
            // Show results section
            resultsSection.classList.remove('hidden');
        }

        function displayError(error) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i>Start Deep Research';
            status.textContent = 'Error Occurred';
            status.className = 'inline-flex items-center bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm';
            status.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error Occurred';
            
            addProgressUpdate(`❌ Error: ${error}`);
        }

        // Health check on load
        fetch('/api/health')
            .then(response => response.json())
            .then(data => {
                console.log('System health:', data);
            })
            .catch(error => {
                console.error('Health check failed:', error);
            });
    </script>
</body>
</html>
